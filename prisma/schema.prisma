generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int           @id @default(autoincrement())
  email             String        @unique
  hashed_password   String
  first_name        String
  last_name         String
  role              UserRole      @default(STUDENT)
  is_representative Boolean       @default(false)
  is_moderator      Boolean       @default(false)
  strikes           Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  groupsRepresented Group[]       @relation("GroupRepresentative")
  srScheduling      SRScheduling?
  moderatedGroups   Group[]       @relation("GroupModerators")
  groupRequests     GroupRequest[]
  strikesByStudent  Strike[]      @relation("StrikeStudent")
  strikesByAdmin    Strike[]      @relation("StrikeAdmin")
  attendance        Attendance[]
}

model GroupRequest {
  id          Int           @id @default(autoincrement())
  userId      Int
  name        String
  goal        String
  description String?
  date        DateTime
  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user        User          @relation(fields: [userId], references: [id])
  group       Group?        @relation("GroupFromRequest")

  @@index([userId, status])
}

model Group {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  description      String?
  reputation       Decimal  @default(0.0) @db.Decimal(3,2)
  representativeId Int
  group_request_id Int?     @unique
  moderators_ids   Json     @default("[]")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  representative   User             @relation("GroupRepresentative", fields: [representativeId], references: [id])
  moderators       User[]           @relation("GroupModerators")
  groupRequest     GroupRequest?    @relation("GroupFromRequest", fields: [group_request_id], references: [id])
  eventRequests    EventRequest[]
  eventsScheduling EventsScheduling[]
}

model StudyRoom {
  id           Int                 @id @default(autoincrement())
  name         String              @unique
  capacity     Int?
  availability AvailabilityStatus  @default(AVAILABLE)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  schedules    SRScheduling[]
}

model PublicSpace {
  id           Int                 @id @default(autoincrement())
  name         String              @unique
  capacity     Int?
  availability AvailabilityStatus  @default(AVAILABLE)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  eventRequests    EventRequest[]
  eventsScheduling EventsScheduling[]
}

model SRScheduling {
  id        Int            @id @default(autoincrement())
  userId    Int            @unique
  srId      Int
  startsAt  DateTime
  endsAt    DateTime
  status    ScheduleStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  user      User           @relation(fields: [userId], references: [id])
  studyRoom StudyRoom      @relation(fields: [srId], references: [id])

  @@unique([srId, startsAt, endsAt])
  @@index([srId, startsAt])
  @@index([userId, startsAt])
}

model EventRequest {
  id              Int           @id @default(autoincrement())
  group_id        Int
  public_space_id Int
  name            String
  goal            String
  description     String?
  date            DateTime
  status          RequestStatus @default(PENDING)
  n_attendees     Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  group           Group         @relation(fields: [group_id], references: [id])
  publicSpace     PublicSpace   @relation(fields: [public_space_id], references: [id])
  eventsScheduling EventsScheduling[]

  @@index([group_id, status])
}

model EventsScheduling {
  id               Int            @id @default(autoincrement())
  public_space_id  Int
  group_id         Int
  event_request_id Int?
  startsAt         DateTime
  endsAt           DateTime
  status           ScheduleStatus @default(PENDING)
  title            String?
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  publicSpace      PublicSpace    @relation(fields: [public_space_id], references: [id])
  group            Group          @relation(fields: [group_id], references: [id])
  eventRequest     EventRequest?  @relation(fields: [event_request_id], references: [id])
  attendance       Attendance[]

  @@unique([public_space_id, startsAt, endsAt])
  @@index([public_space_id, startsAt])
  @@index([group_id, startsAt])
}

model Strike {
  id          Int          @id @default(autoincrement())
  student_id  Int
  description String?
  date        DateTime     @default(now())
  reason      StrikeReason
  admin_id    Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  student     User         @relation("StrikeStudent", fields: [student_id], references: [id])
  admin       User         @relation("StrikeAdmin", fields: [admin_id], references: [id])

  @@index([student_id, date])
}

model Attendance {
  id         Int              @id @default(autoincrement())
  event_id   Int
  student_id Int
  rating     Decimal?         @db.Decimal(2,1)
  feedback   String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  event      EventsScheduling @relation(fields: [event_id], references: [id])
  student    User             @relation(fields: [student_id], references: [id])

  @@unique([student_id, event_id])
  @@index([student_id, event_id])
}

enum UserRole {
  STUDENT
  REPRESENTATIVE
  ADMIN
}

enum ScheduleStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum AvailabilityStatus {
  AVAILABLE
  MAINTENANCE
  UNAVAILABLE
}

enum RequestStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum StrikeReason {
  NO_SHOW
  DAMAGE
  MISUSE
  OTHER
}